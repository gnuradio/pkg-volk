From 971327ca93e4922dfdc91943c6d5fb2c6fddce33 Mon Sep 17 00:00:00 2001
From: Pascal Giard <pascal.giard@lacime.etsmtl.ca>
Date: Fri, 28 Aug 2015 13:13:04 -0400
Subject: [PATCH 07/11] modtool: Rename the ifdef guards in all header files
 where relevant.

Fixes issue #35.
---
 python/volk_modtool/volk_modtool_generate.py | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/python/volk_modtool/volk_modtool_generate.py b/python/volk_modtool/volk_modtool_generate.py
index c7b1201..83e0d26 100644
--- a/python/volk_modtool/volk_modtool_generate.py
+++ b/python/volk_modtool/volk_modtool_generate.py
@@ -30,6 +30,7 @@ class volk_modtool:
     def __init__(self, cfg):
         self.volk = re.compile('volk')
         self.remove_after_underscore = re.compile("_.*")
+        self.volk_included = re.compile('INCLUDED_VOLK')
         self.volk_run_tests = re.compile('^\s*VOLK_RUN_TESTS.*\n', re.MULTILINE)
         self.volk_profile = re.compile('^\s*(VOLK_PROFILE|VOLK_PUPPET_PROFILE).*\n', re.MULTILINE)
         self.volk_kernel_tests = re.compile('^\s*\((VOLK_INIT_TEST|VOLK_INIT_PUPP).*\n', re.MULTILINE)
@@ -105,6 +106,12 @@ class volk_modtool:
                     infile = os.path.join(root, name)
                     instring = open(infile, 'r').read()
                     outstring = re.sub(self.volk, 'volk_' + self.my_dict['name'], instring)
+                    # Update the header ifdef guards only where needed
+                    if((name == "constants.h") or
+                       (name == "volk_complex.h") or
+                       (name == "volk_malloc.h") or
+                       (name == "volk_prefs.h")):
+                        outstring = re.sub(self.volk_included, 'INCLUDED_VOLK_' + self.my_dict['name'].upper(), outstring)
                     newname = re.sub(self.volk, 'volk_' + self.my_dict['name'], name)
                     relpath = os.path.relpath(infile, self.my_dict['base'])
                     newrelpath = re.sub(self.volk, 'volk_' + self.my_dict['name'], relpath)
-- 
2.1.4

